# Post-Restore Fix Checklist for PodcastFlow Pro

## Critical Issues to Fix After Restoration

### 1. **Prerender Manifest Issue** (MOST CRITICAL)
The main issue causing 500 errors is that Next.js 14.1.0 expects certain properties in the prerender manifest that aren't generated by default.

**Fix:**
```bash
# Update the ensure-prerender-manifest.sh script to add required properties
# The script should ensure these properties exist in prerender-manifest.json:
# - version: 4
# - routes: {}
# - dynamicRoutes: {}
# - notFoundRoutes: []
```

**Verification:**
```bash
cat /home/ec2-user/podcastflow-pro/.next/prerender-manifest.json
# Should show: {"preview":{...},"routes":{},"dynamicRoutes":{},"notFoundRoutes":[],"version":4}
```

### 2. **PM2 Configuration**
The ecosystem.config.js must use the shell script, not npm directly.

**Check:**
```bash
grep "script:" /home/ec2-user/podcastflow-pro/ecosystem.config.js
# Should show: script: '/home/ec2-user/podcastflow-pro/start-server.sh',
# Should show: interpreter: '/bin/bash',
```

**If incorrect, fix:**
```javascript
// ecosystem.config.js should have:
script: '/home/ec2-user/podcastflow-pro/start-server.sh',
interpreter: '/bin/bash',
```

### 3. **Missing Error Boundary Files**
Next.js App Router needs these files for proper error handling.

**Check:**
```bash
ls -la /home/ec2-user/podcastflow-pro/src/app/global-error.tsx
ls -la /home/ec2-user/podcastflow-pro/src/app/500.tsx
```

**If missing, create them** (see backup for content).

### 4. **Build and Restart Process**
```bash
# 1. Ensure start-server.sh is executable
chmod +x /home/ec2-user/podcastflow-pro/start-server.sh

# 2. Run the prerender manifest fix
/home/ec2-user/podcastflow-pro/scripts/ensure-prerender-manifest.sh

# 3. Rebuild the application
cd /home/ec2-user/podcastflow-pro
npm run build

# 4. Restart PM2 with correct config
pm2 delete podcastflow-pro
pm2 start ecosystem.config.js
```

### 5. **Verification Steps**
```bash
# 1. Check PM2 is running
pm2 status
# Should show: online

# 2. Test API endpoints
curl -s https://app.podcastflow.pro/api/health | jq .
# Should return: {"status":"ok",...}

# 3. Check for manifest errors in logs
pm2 logs podcastflow-pro --lines 50 | grep "Cannot read properties"
# Should return nothing (no errors)

# 4. Test web UI
curl -I https://app.podcastflow.pro/
# Should return: 307 redirect to /login
```

## Common Error Messages and Solutions

### Error: "Cannot read properties of undefined (reading '/_error')"
**Cause:** Missing routes property in prerender-manifest.json
**Fix:** Run the updated ensure-prerender-manifest.sh script

### Error: "Cannot read properties of undefined (reading '/api/...')"
**Cause:** Same as above - manifest issue
**Fix:** Same as above

### Error: 502 Bad Gateway
**Cause:** PM2 not running or crashed
**Fix:** Check PM2 logs and restart

### Error: "SyntaxError: Invalid or unexpected token"
**Cause:** PM2 trying to run shell script as JavaScript
**Fix:** Update ecosystem.config.js to use bash interpreter

## Quick Recovery Script

Save this as `/home/ec2-user/fix-after-restore.sh`:

```bash
#!/bin/bash
set -e

echo "üîß Fixing PodcastFlow Pro after restore..."

cd /home/ec2-user/podcastflow-pro

echo "1Ô∏è‚É£ Making scripts executable..."
chmod +x start-server.sh
chmod +x scripts/ensure-prerender-manifest.sh

echo "2Ô∏è‚É£ Updating ensure-prerender-manifest.sh..."
# Add the fix to ensure required properties exist
# (Update the script as shown in the session)

echo "3Ô∏è‚É£ Running prerender manifest fix..."
./scripts/ensure-prerender-manifest.sh

echo "4Ô∏è‚É£ Rebuilding application..."
npm run build

echo "5Ô∏è‚É£ Restarting PM2..."
pm2 delete podcastflow-pro || true
pm2 start ecosystem.config.js

echo "6Ô∏è‚É£ Waiting for startup..."
sleep 10

echo "7Ô∏è‚É£ Testing health endpoint..."
curl -s https://app.podcastflow.pro/api/health | jq .

echo "‚úÖ Fix complete! Check the output above for any errors."
```

## Summary

The main issue after restoration is that Next.js 14.1.0's runtime expects a complete prerender manifest with specific properties. The build process only creates a partial manifest, so we need to enhance it post-build. This is handled by the ensure-prerender-manifest.sh script which runs on each PM2 start.

All other changes we made (error pages, PM2 config) are good production practices that should remain in place.